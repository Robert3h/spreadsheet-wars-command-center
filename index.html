import React, { useMemo, useRef, useState, useEffect } from "react";
import { Canvas, useFrame } from "@react-three/fiber";
import { OrbitControls, Stars, Html } from "@react-three/drei";
import { motion, AnimatePresence } from "framer-motion";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from "@/components/ui/sheet";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Search, ChevronRight, Globe2, Sparkles } from "lucide-react";

/**
 * SpreadsheetWars 3D Planet Interactive Site (Single-file Demo)
 *
 * 技術棧：
 * - react + tailwind（外觀）
 * - @react-three/fiber / drei（3D 星球）
 * - framer-motion（動效）
 * - shadcn/ui（UI 元件）
 *
 * 操作：
 * 1) 拖曳旋轉星球、滾輪縮放。
 * 2) 點擊星球上的光點（EP/SP/TLDR），右側會打開清單並自動篩選。
 * 3) 上方可搜尋（標題、番號、關鍵字）。
 * 4) 底部 Chips 可快速切換分類。
 */

// ---- 模擬資料：可依你的完整清單擴充 ----
const articles = [
  { id: "EP01", type: "EP", date: "2025-03-11", title: "首部曲：Excel 報表做了四年，才發現……", link: "#" },
  { id: "EP02", type: "EP", date: "2025-03-18", title: "二部曲：當主管對我說『這工作我真的沒辦法…』", link: "#" },
  { id: "EP05", type: "EP", date: "2025-04-08", title: "五部曲：VBA檢核艦隊的最後防線！", link: "#" },
  { id: "EP06", type: "EP", date: "2025-04-22", title: "六部曲：VBA飛行員 vs. AI無人機", link: "#" },
  { id: "EP07", type: "EP", date: "2025-04-29", title: "七部曲：戴上心智的頭盔", link: "#" },
  { id: "EP08", type: "EP", date: "2025-05-13", title: "八部曲：職場就像一盒巧克力", link: "#" },
  { id: "EP10", type: "EP", date: "2025-06-12", title: "十部曲：按鈕讓信件像洲際飛彈", link: "#" },
  { id: "EP14", type: "EP", date: "2025-08-07", title: "十四部曲：打造自己的模組艦隊", link: "#" },
  { id: "SP01", type: "SP", date: "2025-04-05", title: "外傳一：破窗效應與生活 Bug", link: "#" },
  { id: "SP04", type: "SP", date: "2025-07-23", title: "外傳四：我不想等飛機下墜才搶降落傘", link: "#" },
  { id: "TLDR01", type: "TLDR", date: "2025-06-15", title: "震波行動：一鍵發射 Outlook 洲際導彈", link: "#" },
  { id: "TLDR02", type: "TLDR", date: "2025-07-14", title: "俠盜一號：報表命名檢查器", link: "#" },
  { id: "TLDR03", type: "TLDR", date: "2025-07-28", title: "時間博士：設計魔法函數前去談判", link: "#" },
  { id: "TLDR04", type: "TLDR", date: "2025-08-11", title: "Excel 竟然變成電競比賽？", link: "#" },
];

const categoryColors: Record<string, string> = {
  EP: "bg-blue-600/90",
  SP: "bg-rose-600/90",
  TLDR: "bg-emerald-600/90",
};

// 生成固定且可重現的隨機座標（lat, lon）對應每篇文章；用 seed 讓每次渲染穩定
function seededRandom(seed: number) {
  let t = seed % 2147483647;
  return () => (t = (t * 48271) % 2147483647) / 2147483647;
}

function useArticlePins() {
  return useMemo(() => {
    const rand = seededRandom(1337);
    return articles.map((a, i) => {
      const lat = (rand() * 150 - 75) + (a.type === "SP" ? 15 : a.type === "TLDR" ? -10 : 0); // 分類小偏移
      const lon = rand() * 360 - 180;
      return { ...a, lat, lon };
    });
  }, []);
}

// 將經緯度轉球面座標
function latLonToVector3(lat: number, lon: number, radius = 1.2) {
  const phi = (90 - lat) * (Math.PI / 180);
  const theta = (lon + 180) * (Math.PI / 180);
  const x = -radius * Math.sin(phi) * Math.cos(theta);
  const z = radius * Math.sin(phi) * Math.sin(theta);
  const y = radius * Math.cos(phi);
  return [x, y, z] as [number, number, number];
}

function Planet({ onPick }: { onPick: (type: string) => void }) {
  const group = useRef<any>();
  const [hoverType, setHoverType] = useState<string | null>(null);
  const pins = useArticlePins();

  useFrame((_, delta) => {
    if (group.current) group.current.rotation.y += delta * 0.06; // 慢速自轉
  });

  return (
    <group ref={group}>
      {/* 星球本體 */}
      <mesh castShadow receiveShadow>
        <sphereGeometry args={[1.1, 64, 64]} />
        {/* 簡易雲層/地表質感：利用金屬度與粗糙度做微妙質感 */}
        <meshStandardMaterial color="#0f172a" metalness={0.3} roughness={0.7} />
      </mesh>

      {/* 雲層殼 */}
      <mesh>
        <sphereGeometry args={[1.135, 64, 64]} />
        <meshStandardMaterial transparent opacity={0.12} color="#93c5fd" />
      </mesh>

      {/* 光點 pins */}
      {pins.map((p) => {
        const [x, y, z] = latLonToVector3(p.lat, p.lon, 1.14);
        const color = p.type === "EP" ? "#60a5fa" : p.type === "SP" ? "#fb7185" : "#34d399";
        return (
          <group key={p.id} position={[x, y, z] as any}>
            <mesh
              onPointerOver={(e) => { e.stopPropagation(); setHoverType(p.type); }}
              onPointerOut={() => setHoverType(null)}
              onClick={(e) => { e.stopPropagation(); onPick(p.type); }}
            >
              <sphereGeometry args={[0.02, 16, 16]} />
              <meshStandardMaterial emissive={color} color={color} emissiveIntensity={1.8} />
            </mesh>
            {/* 立起的小光柱效果 */}
            <mesh position={[0, 0.06, 0]}> 
              <cylinderGeometry args={[0.004, 0.004, 0.12, 8]} />
              <meshStandardMaterial emissive={color} color={color} emissiveIntensity={1.2} opacity={0.8} transparent />
            </mesh>
          </group>
        );
      })}

      {/* 星空與光照 */}
      <Stars radius={100} depth={20} count={4000} factor={4} fade />
      <directionalLight position={[3, 2, 1]} intensity={1.2} castShadow />
      <ambientLight intensity={0.25} />
    </group>
  );
}

function Header({ onOpenAll }: { onOpenAll: () => void }) {
  return (
    <div className="absolute top-0 left-0 right-0 z-20 flex items-center justify-between p-4 md:p-6">
      <div className="flex items-center gap-2">
        <div className="h-9 w-9 rounded-xl bg-slate-900/70 border border-slate-700 grid place-items-center">
          <Globe2 className="h-5 w-5 text-slate-200" />
        </div>
        <div className="leading-tight">
          <p className="text-slate-200 text-sm md:text-base font-semibold">SpreadsheetWars</p>
          <p className="text-slate-400 text-[11px] md:text-xs">People are connected through shared values.</p>
        </div>
      </div>
      <div className="flex items-center gap-2">
        <Sheet>
          <SheetTrigger asChild>
            <Button variant="secondary" className="rounded-2xl shadow-sm">導覽 / About</Button>
          </SheetTrigger>
          <SheetContent side="left" className="w-[360px] sm:w-[420px]">
            <SheetHeader>
              <SheetTitle>關於本頁</SheetTitle>
            </SheetHeader>
            <ScrollArea className="h-[80vh] pr-4">
              <div className="mt-4 space-y-4 text-sm text-slate-600">
                <p>這是 Robert 的《試算表大戰》互動式作品集 Demo。拖曳星球、點擊光點可快速篩選 EP / SP / TLDR 文章。</p>
                <p>設計理念：以「星球 × 文章地標」做導覽，結合 3D 與清晰的列表，提高 <span className="font-medium">陌生讀者</span> 的第一印象與探索欲。</p>
                <ul className="list-disc pl-5 space-y-1">
                  <li>3D：@react-three/fiber / drei</li>
                  <li>UI：shadcn/ui + Tailwind</li>
                  <li>動效：framer-motion</li>
                </ul>
                <Button onClick={onOpenAll} className="mt-2 rounded-2xl">開啟全部文章清單</Button>
              </div>
            </ScrollArea>
          </SheetContent>
        </Sheet>
      </div>
    </div>
  );
}

function ArticleList({ q, activeType }: { q: string; activeType: string | "ALL" }) {
  const list = useMemo(() => {
    const query = q.trim().toLowerCase();
    return articles
      .filter(a => (activeType === "ALL" ? true : a.type === activeType))
      .filter(a => !query || `${a.id} ${a.title}`.toLowerCase().includes(query))
      .sort((a, b) => (a.date < b.date ? 1 : -1));
  }, [q, activeType]);

  const groups = useMemo(() => {
    return ["EP", "SP", "TLDR"].map(t => ({
      type: t,
      items: list.filter(a => a.type === t)
    }));
  }, [list]);

  return (
    <div className="space-y-6">
      {groups.map(g => (
        <div key={g.type} className="space-y-3">
          <div className="flex items-center gap-2">
            <div className={`h-2.5 w-2.5 rounded-full ${g.type === "EP" ? "bg-blue-500" : g.type === "SP" ? "bg-rose-500" : "bg-emerald-500"}`} />
            <p className="text-xs uppercase tracking-widest text-slate-500">{g.type}</p>
          </div>
          <div className="grid gap-3">
            {g.items.length === 0 && (
              <p className="text-xs text-slate-400 pl-4">（目前沒有符合條件的內容）</p>
            )}
            {g.items.map(a => (
              <Card key={a.id} className="rounded-2xl border-slate-200">
                <CardHeader className="p-4 pb-0">
                  <CardTitle className="text-base flex items-center justify-between">
                    <span className="truncate">{a.id}｜{a.title}</span>
                    <ChevronRight className="w-4 h-4 text-slate-400" />
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-4 pt-2 text-xs text-slate-500 flex items-center justify-between">
                  <span>{a.date}</span>
                  <a href={a.link} className="underline underline-offset-2">閱讀</a>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}

export default function PlanetSite() {
  const [open, setOpen] = useState(true);
  const [activeType, setActiveType] = useState<"ALL" | "EP" | "SP" | "TLDR">("ALL");
  const [q, setQ] = useState("");
  const [sheetOpen, setSheetOpen] = useState(false);

  useEffect(() => {
    // 避免載入時 3D 尚未呈現，先開啟列表給首次訪客方向
    const timer = setTimeout(() => setOpen(true), 100);
    return () => clearTimeout(timer);
  }, []);

  const FilterChip = ({ label, type }: { label: string; type: "ALL" | "EP" | "SP" | "TLDR" }) => (
    <button
      onClick={() => setActiveType(type)}
      className={`px-3 py-1.5 rounded-2xl text-xs border transition ${
        activeType === type
          ? "bg-slate-900 text-white border-slate-900"
          : "bg-white/60 backdrop-blur border-slate-200 text-slate-600 hover:border-slate-300"
      }`}
    >
      {label}
    </button>
  );

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-800 text-slate-100 relative">
      <Header onOpenAll={() => setOpen(true)} />

      {/* 主舞台 */}
      <div className="grid md:grid-cols-2 gap-0 md:gap-6 px-3 md:px-6 pt-20 pb-24">
        {/* 3D 區塊 */}
        <div className="relative rounded-3xl border border-slate-800/60 shadow-2xl shadow-slate-900/40 overflow-hidden">
          {/* 3D Canvas */}
          <Canvas camera={{ position: [0, 0, 3], fov: 50 }}>
            <Planet onPick={(t) => { setActiveType(t as any); setOpen(true); }} />
            <OrbitControls enablePan={false} minDistance={2} maxDistance={6} />
            {/* 浮動標語 */}
            <Html position={[0, -1.8, 0]} center wrapperClass="select-none">
              <div className="text-center text-xs md:text-sm text-slate-300/80">
                <p className="inline-flex items-center gap-1"><Sparkles className="w-3 h-3"/>點擊光點 → 篩選 EP / SP / TLDR</p>
              </div>
            </Html>
          </Canvas>

          {/* 底部快速篩選 Chips */}
          <div className="absolute bottom-3 left-0 right-0 flex items-center justify-center gap-2">
            <FilterChip label="全部" type="ALL" />
            <FilterChip label="EP" type="EP" />
            <FilterChip label="SP" type="SP" />
            <FilterChip label="TLDR" type="TLDR" />
          </div>
        </div>

        {/* 右側：列表 / 搜尋 */}
        <div className="relative">
          <AnimatePresence>
            {open && (
              <motion.div
                initial={{ opacity: 0, y: 12 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: 12 }}
                transition={{ duration: 0.28 }}
                className="rounded-3xl bg-white/90 backdrop-blur border border-slate-200 p-4 md:p-6 h-[62vh] md:h-[70vh] overflow-hidden"
              >
                <div className="flex items-center gap-2 mb-4">
                  <div className={`h-8 w-8 rounded-xl grid place-items-center text-white ${activeType === "EP" ? "bg-blue-600" : activeType === "SP" ? "bg-rose-600" : activeType === "TLDR" ? "bg-emerald-600" : "bg-slate-900"}`}>
                    {(activeType as string) !== "ALL" ? (activeType as string) : "ALL"}
                  </div>
                  <div className="flex-1 relative">
                    <Search className="w-4 h-4 text-slate-400 absolute left-3 top-2.5" />
                    <Input value={q} onChange={(e) => setQ(e.target.value)} placeholder="搜尋標題、番號、關鍵字…" className="pl-9 rounded-2xl" />
                  </div>
                  <Button variant="ghost" onClick={() => { setActiveType("ALL"); setQ(""); }}>清除</Button>
                </div>
                <ScrollArea className="h-[calc(100%-56px)] pr-4">
                  <ArticleList q={q} activeType={activeType} />
                </ScrollArea>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>

      {/* Footer */}
      <div className="px-6 pb-8 text-center text-[11px] text-slate-400/80">
        <p>© {new Date().getFullYear()} Robert Huang — People are connected through shared values and convictions.</p>
      </div>
    </div>
  );
}
